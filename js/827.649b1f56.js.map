{"version":3,"file":"js/827.649b1f56.js","mappings":"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","sources":["webpack://yooa-com/./src/incremental/leaderboard.js"],"sourcesContent":["// leaderboard.js â€” robust v6-friendly, falls back to fetch if Amplify.API missing\r\nimport { fetchAuthSession, getCurrentUser, fetchUserAttributes } from 'aws-amplify/auth';\r\nimport { API } from 'aws-amplify'; // may be undefined in some bundling environments\r\nimport awsExports from '@/aws-exports';\r\n\r\n/**\r\n * Resolve the API base URL for an Amplify API name by inspecting aws-exports.\r\n * Returns null if not found.\r\n */\r\nfunction getApiBaseUrlFromExports(apiName = 'YooAIncrementalAPI') {\r\n  try {\r\n    // Amplify classic export shape: aws_cloud_logic_custom is an array of { name, endpoint }\r\n    const cloudLogic = awsExports?.aws_cloud_logic_custom;\r\n    if (Array.isArray(cloudLogic)) {\r\n      const found = cloudLogic.find(e => e && (e.name === apiName || e.apiName === apiName));\r\n      if (found) return found.endpoint || found.url || null;\r\n    }\r\n    // Amplify newer shape: API endpoints may live under aws_exports.API or similar\r\n    const endpoints = awsExports?.API?.endpoints || awsExports?.api?.endpoints;\r\n    if (Array.isArray(endpoints)) {\r\n      const found = endpoints.find(e => e && (e.name === apiName || e.apiName === apiName));\r\n      if (found) return found.endpoint || found.url || null;\r\n    }\r\n  } catch (e) {\r\n    // ignore\r\n  }\r\n  // final fallback: known default from your Options.vue earlier\r\n  return 'https://z4frjlkbjb.execute-api.us-east-1.amazonaws.com/dev';\r\n}\r\n\r\n/**\r\n * Helper to perform POST either via Amplify.API or fetch fallback.\r\n */\r\nasync function postToApi(path, body, idToken = null) {\r\n  // If Amplify API is available and has a post method, use it.\r\n  if (API && typeof API.post === 'function') {\r\n    try {\r\n      return await API.post('YooAIncrementalAPI', path, {\r\n        body,\r\n        headers: idToken ? { Authorization: `Bearer ${idToken}` } : undefined\r\n      });\r\n    } catch (e) {\r\n      // fall through to fetch fallback if Amplify API.post fails for any reason\r\n      console.warn('Amplify API.post failed, falling back to fetch():', e);\r\n    }\r\n  }\r\n\r\n  // fetch fallback\r\n  const base = getApiBaseUrlFromExports('YooAIncrementalAPI') || 'https://z4frjlkbjb.execute-api.us-east-1.amazonaws.com/dev';\r\n  // Ensure base doesn't end with slash, path does start with '/'\r\n  const url = (base.endsWith('/') ? base.slice(0, -1) : base) + (path.startsWith('/') ? path : '/' + path);\r\n  const headers = { 'Content-Type': 'application/json' };\r\n  if (idToken) headers['Authorization'] = `Bearer ${idToken}`;\r\n  const res = await fetch(url, {\r\n    method: 'POST',\r\n    headers,\r\n    body: JSON.stringify(body)\r\n  });\r\n  if (!res.ok) {\r\n    const text = await res.text().catch(() => '');\r\n    throw new Error(`Fetch POST ${res.status} ${res.statusText} ${text}`);\r\n  }\r\n  // try to parse JSON, but don't assume it's always JSON\r\n  try { return await res.json(); } catch (e) { return null; }\r\n}\r\n\r\nclass LeaderboardService {\r\n  /**\r\n   * Save player data to leaderboard.\r\n   * - YooAPoints: Decimal-like or number\r\n   * - meta: optional object { displayName?: string|null, avatarKey?: string|null, avatarUrl?: string|null }\r\n   * - slot: optional slot string (default \"main\")\r\n   */\r\n  async savePlayerData(YooAPoints, meta = {}, slot = \"main\") {\r\n    try {\r\n      // Try to get the current user (v6 helper)\r\n      let user = null;\r\n      try {\r\n        user = await getCurrentUser().catch(() => null);\r\n      } catch (e) {\r\n        user = null;\r\n      }\r\n\r\n      if (!user) {\r\n        console.warn(\"savePlayerData: no authenticated user\");\r\n        return false;\r\n      }\r\n\r\n      // Try to get ID token via fetchAuthSession (v6)\r\n      let idToken = null;\r\n      try {\r\n        const session = await fetchAuthSession();\r\n        idToken = session?.tokens?.idToken?.toString?.() || session?.tokens?.idToken?.jwtToken || null;\r\n      } catch (e) {\r\n        idToken = user?.signInUserSession?.idToken?.jwtToken ?? null;\r\n      }\r\n\r\n      // Build payload\r\n      const payload = {\r\n        slot,\r\n        scoreRaw: String(YooAPoints ?? 0)\r\n      };\r\n\r\n      // Normalize meta param\r\n      let actualDisplayName = null;\r\n      let actualAvatarKeyOrUrl = undefined; // undefined = unknown, null = explicitly empty\r\n\r\n      if (meta && typeof meta === 'object') {\r\n        if (typeof meta.displayName === 'string' && meta.displayName.trim() !== '') actualDisplayName = meta.displayName;\r\n        if (typeof meta.avatarKey === 'string' && meta.avatarKey.trim() !== '') actualAvatarKeyOrUrl = meta.avatarKey;\r\n        else if (typeof meta.avatarUrl === 'string' && meta.avatarUrl.trim() !== '') actualAvatarKeyOrUrl = meta.avatarUrl;\r\n      }\r\n\r\n      // If anything is missing, try to read Cognito attributes\r\n      if (!actualDisplayName || typeof actualAvatarKeyOrUrl === 'undefined') {\r\n        try {\r\n          const attrsRaw = await fetchUserAttributes().catch(() => null);\r\n          const attrsMap = {};\r\n          if (Array.isArray(attrsRaw)) {\r\n            attrsRaw.forEach(a => {\r\n              const name = a.Name || a.name;\r\n              const value = a.Value || a.value;\r\n              if (name) attrsMap[name] = value;\r\n            });\r\n          } else if (attrsRaw && typeof attrsRaw === 'object') {\r\n            Object.assign(attrsMap, attrsRaw);\r\n          }\r\n\r\n          if (!actualDisplayName) actualDisplayName = attrsMap['custom:displayName'] || attrsMap['name'] || attrsMap['email'] || user?.username || null;\r\n          if (typeof actualAvatarKeyOrUrl === 'undefined') {\r\n            const pic = attrsMap['custom:picture'] || attrsMap['picture'] || null;\r\n            if (pic) actualAvatarKeyOrUrl = pic;\r\n          }\r\n        } catch (e) {\r\n          console.warn('savePlayerData: fetchUserAttributes failed', e);\r\n        }\r\n      }\r\n\r\n      if (actualDisplayName) payload.displayName = String(actualDisplayName);\r\n      if (actualAvatarKeyOrUrl) payload.avatarKey = String(actualAvatarKeyOrUrl);\r\n\r\n      // Post to API (using either Amplify API or fetch fallback)\r\n      const res = await postToApi('/leaderboard/update', payload, idToken);\r\n\r\n      console.log(\"leaderboard update response:\", res);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Failed to save to leaderboard:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async getTopPlayers(limit = 100) {\r\n    try {\r\n      // prefer Amplify API.get if present\r\n      if (API && typeof API.get === 'function') {\r\n        const response = await API.get('YooAIncrementalAPI', '/leaderboard/top', {\r\n          queryStringParameters: { limit: String(limit) }\r\n        });\r\n        return (response && response.items) ? response.items : [];\r\n      } else {\r\n        // fallback fetch\r\n        const base = getApiBaseUrlFromExports('YooAIncrementalAPI');\r\n        const url = (base.endsWith('/') ? base.slice(0, -1) : base) + '/leaderboard/top?limit=' + encodeURIComponent(String(limit));\r\n        const r = await fetch(url);\r\n        if (!r.ok) throw new Error('GET failed ' + r.status);\r\n        const data = await r.json();\r\n        return (data && data.items) ? data.items : [];\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to get leaderboard:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async getUserRank(userId = null) {\r\n    try {\r\n      if (!userId) {\r\n        let user = null;\r\n        try {\r\n          user = await getCurrentUser().catch(() => null);\r\n        } catch (e) {\r\n          user = null;\r\n        }\r\n        userId = user?.attributes?.sub || user?.username;\r\n      }\r\n      if (!userId) return null;\r\n\r\n      if (API && typeof API.get === 'function') {\r\n        const response = await API.get('YooAIncrementalAPI', '/leaderboard/rank', {\r\n          queryStringParameters: { userId }\r\n        });\r\n        return response;\r\n      } else {\r\n        const base = getApiBaseUrlFromExports('YooAIncrementalAPI');\r\n        const url = (base.endsWith('/') ? base.slice(0, -1) : base) + '/leaderboard/rank?userId=' + encodeURIComponent(String(userId));\r\n        const r = await fetch(url);\r\n        if (!r.ok) throw new Error('GET failed ' + r.status);\r\n        return await r.json();\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to get user rank:', error);\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\nexport default new LeaderboardService();\r\n"],"names":["getApiBaseUrlFromExports","apiName","cloudLogic","awsExports","aws_cloud_logic_custom","Array","isArray","found","find","e","name","endpoint","url","endpoints","API","api","async","postToApi","path","body","idToken","headers","Authorization","undefined","console","warn","base","endsWith","slice","startsWith","res","fetch","method","JSON","stringify","ok","text","catch","Error","status","statusText","json","LeaderboardService","savePlayerData","YooAPoints","meta","slot","user","getCurrentUser","session","fetchAuthSession","tokens","toString","jwtToken","signInUserSession","payload","scoreRaw","String","actualAvatarKeyOrUrl","actualDisplayName","displayName","trim","avatarKey","avatarUrl","attrsRaw","fetchUserAttributes","attrsMap","forEach","a","Name","value","Value","Object","assign","username","pic","log","error","getTopPlayers","limit","response","queryStringParameters","items","encodeURIComponent","r","data","getUserRank","userId","attributes","sub"],"sourceRoot":""}