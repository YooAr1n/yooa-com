{"version":3,"file":"js/827.7deffc06.js","mappings":"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","sources":["webpack://yooa-com/./src/incremental/leaderboard.js"],"sourcesContent":["// leaderboard.js â€” robust v6-friendly, falls back to fetch if Amplify.API missing\nimport { fetchAuthSession, getCurrentUser, fetchUserAttributes } from 'aws-amplify/auth';\nimport { API } from 'aws-amplify'; // may be undefined in some bundling environments\nimport awsExports from '@/aws-exports';\n\n/**\n * Resolve the API base URL for an Amplify API name by inspecting aws-exports.\n * Returns null if not found.\n */\nfunction getApiBaseUrlFromExports(apiName = 'YooAIncrementalAPI') {\n  try {\n    // Amplify classic export shape: aws_cloud_logic_custom is an array of { name, endpoint }\n    const cloudLogic = awsExports?.aws_cloud_logic_custom;\n    if (Array.isArray(cloudLogic)) {\n      const found = cloudLogic.find(e => e && (e.name === apiName || e.apiName === apiName));\n      if (found) return found.endpoint || found.url || null;\n    }\n    // Amplify newer shape: API endpoints may live under aws_exports.API or similar\n    const endpoints = awsExports?.API?.endpoints || awsExports?.api?.endpoints;\n    if (Array.isArray(endpoints)) {\n      const found = endpoints.find(e => e && (e.name === apiName || e.apiName === apiName));\n      if (found) return found.endpoint || found.url || null;\n    }\n  } catch (e) {\n    // ignore\n  }\n  // final fallback: known default from your Options.vue earlier\n  return 'https://z4frjlkbjb.execute-api.us-east-1.amazonaws.com/dev';\n}\n\n/**\n * Helper to perform POST either via Amplify.API or fetch fallback.\n */\nasync function postToApi(path, body, idToken = null) {\n  // If Amplify API is available and has a post method, use it.\n  if (API && typeof API.post === 'function') {\n    try {\n      return await API.post('YooAIncrementalAPI', path, {\n        body,\n        headers: idToken ? { Authorization: `Bearer ${idToken}` } : undefined\n      });\n    } catch (e) {\n      // fall through to fetch fallback if Amplify API.post fails for any reason\n      console.warn('Amplify API.post failed, falling back to fetch():', e);\n    }\n  }\n\n  // fetch fallback\n  const base = getApiBaseUrlFromExports('YooAIncrementalAPI') || 'https://z4frjlkbjb.execute-api.us-east-1.amazonaws.com/dev';\n  // Ensure base doesn't end with slash, path does start with '/'\n  const url = (base.endsWith('/') ? base.slice(0, -1) : base) + (path.startsWith('/') ? path : '/' + path);\n  const headers = { 'Content-Type': 'application/json' };\n  if (idToken) headers['Authorization'] = `Bearer ${idToken}`;\n  const res = await fetch(url, {\n    method: 'POST',\n    headers,\n    body: JSON.stringify(body)\n  });\n  if (!res.ok) {\n    const text = await res.text().catch(() => '');\n    throw new Error(`Fetch POST ${res.status} ${res.statusText} ${text}`);\n  }\n  // try to parse JSON, but don't assume it's always JSON\n  try { return await res.json(); } catch (e) { return null; }\n}\n\nclass LeaderboardService {\n  /**\n   * Save player data to leaderboard.\n   * - YooAPoints: Decimal-like or number\n   * - meta: optional object { displayName?: string|null, avatarKey?: string|null, avatarUrl?: string|null }\n   * - slot: optional slot string (default \"main\")\n   */\n  async savePlayerData(YooAPoints, meta = {}, slot = \"main\") {\n    try {\n      // Try to get the current user (v6 helper)\n      let user = null;\n      try {\n        user = await getCurrentUser().catch(() => null);\n      } catch (e) {\n        user = null;\n      }\n\n      if (!user) {\n        console.warn(\"savePlayerData: no authenticated user\");\n        return false;\n      }\n\n      // Try to get ID token via fetchAuthSession (v6)\n      let idToken = null;\n      try {\n        const session = await fetchAuthSession();\n        idToken = session?.tokens?.idToken?.toString?.() || session?.tokens?.idToken?.jwtToken || null;\n      } catch (e) {\n        idToken = user?.signInUserSession?.idToken?.jwtToken ?? null;\n      }\n\n      // Build payload\n      const payload = {\n        slot,\n        scoreRaw: String(YooAPoints ?? 0)\n      };\n\n      // Normalize meta param\n      let actualDisplayName = null;\n      let actualAvatarKeyOrUrl = undefined; // undefined = unknown, null = explicitly empty\n\n      if (meta && typeof meta === 'object') {\n        if (typeof meta.displayName === 'string' && meta.displayName.trim() !== '') actualDisplayName = meta.displayName;\n        if (typeof meta.avatarKey === 'string' && meta.avatarKey.trim() !== '') actualAvatarKeyOrUrl = meta.avatarKey;\n        else if (typeof meta.avatarUrl === 'string' && meta.avatarUrl.trim() !== '') actualAvatarKeyOrUrl = meta.avatarUrl;\n      }\n\n      // If anything is missing, try to read Cognito attributes\n      if (!actualDisplayName || typeof actualAvatarKeyOrUrl === 'undefined') {\n        try {\n          const attrsRaw = await fetchUserAttributes().catch(() => null);\n          const attrsMap = {};\n          if (Array.isArray(attrsRaw)) {\n            attrsRaw.forEach(a => {\n              const name = a.Name || a.name;\n              const value = a.Value || a.value;\n              if (name) attrsMap[name] = value;\n            });\n          } else if (attrsRaw && typeof attrsRaw === 'object') {\n            Object.assign(attrsMap, attrsRaw);\n          }\n\n          if (!actualDisplayName) actualDisplayName = attrsMap['custom:displayName'] || attrsMap['name'] || attrsMap['email'] || user?.username || null;\n          if (typeof actualAvatarKeyOrUrl === 'undefined') {\n            const pic = attrsMap['custom:picture'] || attrsMap['picture'] || null;\n            if (pic) actualAvatarKeyOrUrl = pic;\n          }\n        } catch (e) {\n          console.warn('savePlayerData: fetchUserAttributes failed', e);\n        }\n      }\n\n      if (actualDisplayName) payload.displayName = String(actualDisplayName);\n      if (actualAvatarKeyOrUrl) payload.avatarKey = String(actualAvatarKeyOrUrl);\n\n      // Post to API (using either Amplify API or fetch fallback)\n      const res = await postToApi('/leaderboard/update', payload, idToken);\n\n      console.log(\"leaderboard update response:\", res);\n      return true;\n    } catch (error) {\n      console.error('Failed to save to leaderboard:', error);\n      return false;\n    }\n  }\n\n  async getTopPlayers(limit = 100) {\n    try {\n      // prefer Amplify API.get if present\n      if (API && typeof API.get === 'function') {\n        const response = await API.get('YooAIncrementalAPI', '/leaderboard/top', {\n          queryStringParameters: { limit: String(limit) }\n        });\n        return (response && response.items) ? response.items : [];\n      } else {\n        // fallback fetch\n        const base = getApiBaseUrlFromExports('YooAIncrementalAPI');\n        const url = (base.endsWith('/') ? base.slice(0, -1) : base) + '/leaderboard/top?limit=' + encodeURIComponent(String(limit));\n        const r = await fetch(url);\n        if (!r.ok) throw new Error('GET failed ' + r.status);\n        const data = await r.json();\n        return (data && data.items) ? data.items : [];\n      }\n    } catch (error) {\n      console.error('Failed to get leaderboard:', error);\n      return [];\n    }\n  }\n\n  async getUserRank(userId = null) {\n    try {\n      if (!userId) {\n        let user = null;\n        try {\n          user = await getCurrentUser().catch(() => null);\n        } catch (e) {\n          user = null;\n        }\n        userId = user?.attributes?.sub || user?.username;\n      }\n      if (!userId) return null;\n\n      if (API && typeof API.get === 'function') {\n        const response = await API.get('YooAIncrementalAPI', '/leaderboard/rank', {\n          queryStringParameters: { userId }\n        });\n        return response;\n      } else {\n        const base = getApiBaseUrlFromExports('YooAIncrementalAPI');\n        const url = (base.endsWith('/') ? base.slice(0, -1) : base) + '/leaderboard/rank?userId=' + encodeURIComponent(String(userId));\n        const r = await fetch(url);\n        if (!r.ok) throw new Error('GET failed ' + r.status);\n        return await r.json();\n      }\n    } catch (error) {\n      console.error('Failed to get user rank:', error);\n      return null;\n    }\n  }\n}\n\nexport default new LeaderboardService();\n"],"names":["getApiBaseUrlFromExports","apiName","cloudLogic","awsExports","aws_cloud_logic_custom","Array","isArray","found","find","e","name","endpoint","url","endpoints","API","api","async","postToApi","path","body","idToken","headers","Authorization","undefined","console","warn","base","endsWith","slice","startsWith","res","fetch","method","JSON","stringify","ok","text","catch","Error","status","statusText","json","LeaderboardService","savePlayerData","YooAPoints","meta","slot","user","getCurrentUser","session","fetchAuthSession","tokens","toString","jwtToken","signInUserSession","payload","scoreRaw","String","actualAvatarKeyOrUrl","actualDisplayName","displayName","trim","avatarKey","avatarUrl","attrsRaw","fetchUserAttributes","attrsMap","forEach","a","Name","value","Value","Object","assign","username","pic","log","error","getTopPlayers","limit","response","queryStringParameters","items","encodeURIComponent","r","data","getUserRank","userId","attributes","sub"],"sourceRoot":""}